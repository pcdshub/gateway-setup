# Start w/ a standard PCDS epics environment
export SETUP_SITE_TOP=/cds/group/pcds/setup
source $SETUP_SITE_TOP/epicsenv-cur.sh

# Utility variables
#export IP=`/sbin/ifconfig eth0 | /bin/grep 'inet addr:' | /bin/cut -d: -f2 | /bin/awk '{ print $1 }'`
export IP=`/sbin/ifconfig | /bin/grep -w inet | head -1 | sed -e 's/ *inet[^0-9]*\([0-9.]*\) .*/\1/'`
export LO_IP=127.0.0.1
export LO_BC=127.0.0.255

# pscag1 interface ip addresses
# FEE changed to HXR, then to LFE
# SXR changed to KFE
export CXI_IF1=172.21.68.20
export DET_IF1=172.21.58.20
export DEV_IF1=134.79.165.20
export DRP_IF1=172.21.156.20
export KFE_IF1=172.21.92.20
export LAS_IF1=172.21.35.20
export LFE_IF1=172.21.88.20
export MCC_IF1=172.21.40.20
export MEC_IF1=172.21.76.20
export MFX_IF1=172.21.72.20
export RIX_IF1=172.21.140.20
export SRV_IF1=172.21.32.24
export THZ_IF1=172.21.57.20
export TMO_IF1=172.21.132.20
export TST_IF1=172.21.148.20
export XCS_IF1=172.21.80.20
export XPP_IF1=172.21.84.20
# Don't include SRV
export PSCAG1_IFLIST="$CXI_IF1 $DET_IF1 $DEV_IF1 $DRP_IF1 $KFE_IF1 $LAS_IF1 $LFE_IF1 $MCC_IF1 $MEC_IF1 $MFX_IF1 $RIX_IF1 $THZ_IF1 $TMO_IF1 $TST_IF1 $XCS_IF1 $XPP_IF1"

# pscag2 interface ip addresses
export CXI_IF2=172.21.68.19
export DET_IF2=172.21.58.19
export DEV_IF2=134.79.165.19
export DRP_IF2=172.21.156.19
export KFE_IF2=172.21.92.19
export LAS_IF2=172.21.35.19
export LFE_IF2=172.21.88.19
export MCC_IF2=172.21.40.19
export MEC_IF2=172.21.76.19
export MFX_IF2=172.21.72.19
export RIX_IF2=172.21.140.19
export SRV_IF2=172.21.32.25
export THZ_IF2=172.21.57.19
export TMO_IF2=172.21.132.19
export TST_IF2=172.21.148.19
export XCS_IF2=172.21.80.19
export XPP_IF2=172.21.84.19
# Don't include SRV
export PSCAG2_IFLIST="$CXI_IF2 $DET_IF2 $DEV_IF2 $DRP_IF2 $KFE_IF2 $LAS_IF2 $LFE_IF2 $MCC_IF2 $MEC_IF2 $MFX_IF2 $RIX_IF2 $THZ_IF2 $TMO_IF2 $TST_IF2 $XCS_IF2 $XPP_IF2"

# pscag3 interface ip addresses
export CXI_IF3=172.21.68.251
export DET_IF3=172.21.58.251
export DEV_IF3=134.79.165.57
export DRP_IF3=172.21.156.251
export KFE_IF3=172.21.92.251
export LAS_IF3=172.21.35.251
export LFE_IF3=172.21.88.251
export MCC_IF3=172.21.40.21
export MEC_IF3=172.21.76.251
export MFX_IF3=172.21.72.251
export RIX_IF3=172.21.140.251
export SRV_IF3=172.21.32.54
export THZ_IF3=172.21.57.251
export TMO_IF3=172.21.132.251
export TST_IF3=172.21.148.251
export XCS_IF3=172.21.80.251
export XPP_IF3=172.21.84.251
# Don't include SRV
export PSCAG3_IFLIST="$CXI_IF3 $DET_IF3 $DEV_IF3 $DRP_IF3 $KFE_IF3 $LAS_IF3 $LFE_IF3 $MCC_IF3 $MEC_IF3 $MFX_IF3 $RIX_IF3 $THZ_IF3 $TMO_IF3 $TST_IF3 $XCS_IF3 $XPP_IF3"

# pscag4 interface ip addresses
export CXI_IF4=172.21.68.16
export DET_IF4=172.21.58.16
export DEV_IF4=134.79.165.16
export DRP_IF4=172.21.156.16
export KFE_IF4=172.21.92.16
export LAS_IF4=172.21.35.16
export LFE_IF4=172.21.88.16
export MCC_IF4=172.21.40.16
export MEC_IF4=172.21.76.16
export MFX_IF4=172.21.72.16
export RIX_IF4=172.21.140.16
export SRV_IF4=172.21.32.16
export THZ_IF4=172.21.57.16
export TMO_IF4=172.21.132.16
export TST_IF4=172.21.148.16
export XCS_IF4=172.21.80.16
export XPP_IF4=172.21.84.16
# Don't include SRV
export PSCAG4_IFLIST="$CXI_IF4 $DET_IF4 $DEV_IF4 $DRP_IF4 $KFE_IF4 $LAS_IF4 $LFE_IF4 $MCC_IF4 $MEC_IF4 $MFX_IF4 $RIX_IF4 $THZ_IF4 $TMO_IF4 $TST_IF4 $XCS_IF4 $XPP_IF4"

# pscaglab2 interface ip addresses
export LAB2_BC=134.79.219.255
export B34_IFLAB2=134.79.217.150
export TST_IFLAB2=172.21.148.237
export PSCAGLAB2_IFLIST="$B34_IFLAB2 $TST_IFLAB2"

export ALL_PSCAG_IFLIST="$PSCAG1_IFLIST $PSCAG2_IFLIST $PSCAG3_IFLIST $PSCAG4_IFLIST $PSCAGLAB2_IFLIST "

# Broadcast addresses
export DEV_BC=134.79.165.255
export DRP_BC=172.21.159.255
export MCC1_BC=172.27.11.255
export MCC2_BC=172.27.3.255
export MCC_BC="$MCC1_BC $MCC2_BC"
export SRV_BC=172.21.32.255
export LAS_BC=172.21.35.255
export LFE_BC=172.21.91.255
export THZ_BC=172.21.57.255
export TMO_BC=172.21.135.255
export DET_BC=172.21.58.255
export KFE_BC=172.21.95.255
export SXR_BC=172.21.95.255
export RIX_BC=172.21.143.255
export XPP_BC=172.21.87.255
export TST_BC=172.21.151.255
export XCS_BC=172.21.83.255
export CXI_BC=172.21.71.255
export MEC_BC=172.21.79.255
export MFX_BC=172.21.75.255
export BC_LIST="$DEV_BC $DRP_BC $MCC1_BC $MCC2_BC $LAS_BC $LFE_BC $THZ_BC $TMO_BC $DET_BC $KFE_BC $RIX_BC $XPP_BC $TST_BC $XCS_BC $CXI_BC $MEC_BC $MFX_BC $LAB2_BC"

export MCC_GW=172.27.224.220

# Common to all
export EPICS_CA_BEACON_PERIOD=20.0
export EPICS_CA_CONN_TMO=60.0
export EPICS_CA_MAX_ARRAY_BYTES=40000000
export EPICS_CA_AUTO_ADDR_LIST=NO
export EPICS_CAS_AUTO_BEACON_ADDR_LIST=NO

# gateway servers should not serve PVs to other gateway servers
# Start out having the gateway servers ignore all the gateway interfaces
export EPICS_CAS_IGNORE_ADDR_LIST="$ALL_PSCAG_IFLIST"
# Strip out the dev interfaces so we have access from gateway hosts and usr machines
export EPICS_CAS_IGNORE_ADDR_LIST=`echo $EPICS_CAS_IGNORE_ADDR_LIST | sed -e "s%${DEV_IF1}%%" `
export EPICS_CAS_IGNORE_ADDR_LIST=`echo $EPICS_CAS_IGNORE_ADDR_LIST | sed -e "s%${DEV_IF2}%%" `
export EPICS_CAS_IGNORE_ADDR_LIST=`echo $EPICS_CAS_IGNORE_ADDR_LIST | sed -e "s%${DEV_IF3}%%" `
export EPICS_CAS_IGNORE_ADDR_LIST=`echo $EPICS_CAS_IGNORE_ADDR_LIST | sed -e "s%${DEV_IF4}%%" `

export EPICS_CAS_BEACON_ADDR_LIST="\
$DEV_BC:5065 $DRP_BC:5065 $MCC1_BC:5069 $MCC2_BC:5069 $LAS_BC:5065 $LFE_BC:5065 $THZ_BC:5065 $TMO_BC:5065 $DET_BC:5065 $KFE_BC:5065 $RIX_BC:5065 $XPP_BC:5065 $XCS_BC:5065 $CXI_BC:5065 $MEC_BC:5065 $MFX_BC:5065 $TST_BC:5065 $LO_BC"
export DAEMON_COREFILE_LIMIT="unlimited"

# Common to most
export EPICS_CA_SERVER_PORT=5064
export EPICS_CAS_SERVER_PORT=5064
export EPICS_PVA_SERVER_PORT=5075
export EPICS_PVA_BROADCAST_PORT=5076

GW_TOP="/cds/group/pcds/gateway"
cagvardir="$GW_TOP/logs"
cagcfgdir="$GW_TOP/config"
cagscriptdir="$GW_TOP/scripts"
cagprogram="/cds/group/pcds/epics/extensions/gateway/R2.1.2.0-1.3.0/bin/$EPICS_HOST_ARCH/gateway"
procServ="/cds/group/pcds/pkg_mgr/release/procServ/2.7.0-1.3.0/$EPICS_HOST_ARCH/bin/procServ"
cagdbg=""

cagstart() {
  echo -n "Starting $1 CA gateway... "
  TIME=`date +%Y_%m_%d-%T`
  mkdir -p $cagvardir/$1
  /bin/rm -f $cagvardir/$1/gateway.log
  /bin/rm -f $cagvardir/$1/gateway-put.log
  ln -s $cagvardir/$1/gateway.log.$TIME $cagvardir/$1/gateway.log
  ln -s $cagvardir/$1/gateway-put.log.$TIME $cagvardir/$1/gateway-put.log
  PROCSERV="$procServ --allow --ignore ^D^C --logfile $cagvardir/$1/gateway.log.$TIME --name $1 $3"
  $PROCSERV $cagprogram -access $cagcfgdir/pcds-access.acf -pvlist $cagcfgdir/$1.pvlist -home $cagvardir/$1 $cagdbg -prefix $2 -command $cagvardir/gateway.command -putlog $cagvardir/$gwname/gateway-put.log $4 $5 $6 $7 
  echo " done"
}

PYTHON_EXE=`which python`
pvaLogsDir="$GW_TOP/pva-logs"
P4P_TOP=/cds/group/pcds/epics/extensions/p4p/R3.5.1-1.0.0
P4P_ARGS=""
#P4P_ARGS="--logging $GW_TOP/scripts/pva-logging.yaml"

pvaStart() {
	echo "Starting $1 PVA gateway... "

	# Configure environment for p4p.gw
	source $P4P_TOP/pcds_setup_env.sh
	PYTHON_EXE=`which python`

	TIME=`date +%Y_%m_%d-%T`
	mkdir -p $pvaLogsDir/$1
	/bin/rm -f $pvaLogsDir/$1/pva.log
	/bin/rm -f $pvaLogsDir/$1/pva-put.log
	ln -s $pvaLogsDir/$1/pva.log.$TIME $pvaLogsDir/$1/pva.log
	ln -s $pvaLogsDir/$1/pva-put.log.$TIME $pvaLogsDir/$1/pva-put.log
	cd $pvaLogsDir/$1
	PROCSERV="$procServ --allow --ignore ^D^C --logfile $pvaLogsDir/$1/pva.log.$TIME --name pva-$1 $2"
	$PROCSERV $PYTHON_EXE -m p4p.gw $P4P_ARGS $pvaLogsDir/$1/pvagw-$1.json
	echo " done"
}
